--copy rewards_impact_data so to keep original nice and neat
create table REWARDS_IMPACT_DATA_V5 as select * from rewards_impact_data;

commit;

--check table = 819,249
select * from REWARDS_IMPACT_DATA_V5


--Fix DATES
UPDATE REWARDS_IMPACT_DATA_V5
SET contract_end_dt = TRIM(TO_DATE('01-JAN-00', 'dd mon yy'))
where contract_end_dt > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));


UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_END =  TRIM(TO_DATE('01-JAN-00', 'dd mon yy'))
where ELEC_END > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_END = TRIM(TO_DATE('01-JAN-00', 'dd mon yy'))
where GAS_END > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET BOILERID = NULL
where BOILER_SERVICE > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET BOILER_SERVICE = NULL
where BOILER_SERVICE > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILDCARD_USED = NULL
where ELEC_WILDCARD_USED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILCARD_OFFERED = NULL
where ELEC_WILDCARD_USED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILDCARD_USED_DATE = NULL
where ELEC_WILDCARD_USED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET REGISTRATION_STATUS = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET FIRST_LOGIN = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET USER_STATUS = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET REWARDS_PROFILE_ID = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET BOOST_AMOUNT = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET TESCO_CLUBCARD = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET PASSCODE_CNT = NULL
where REGISTERED_DATE  >TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET BOOST_COUNT = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET BOOST_COUNT_12MNTH = NULL
where REGISTERED_DATE  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET REGISTERED_DATE = NULL
where REGISTERED_DATE  >TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET CONTRACT_END_DT = NULL
where CONTRACT_START_DT  >TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET CONTRACT_START_DT = NULL
where CONTRACT_START_DT  > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_END = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_ACCOUNT_STATUS = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_TYPE_BILLPAY = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILDCARD_USED = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILCARD_OFFERED = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_WILDCARD_USED_DATE = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_LEVELPAY_DSCNT = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_PAPERLESS_DSCNT = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_START = NULL
WHERE ELEC_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_END = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_ACCOUNT_STATUS = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_TYPE_BILLPAY = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_LEVELPAY_DSCNT = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_PAPERLESS_DSCNT = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));

UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_START = NULL
WHERE GAS_START > TRIM(TO_DATE('24-APR-17', 'dd mon yy'));


--fix 01-jan-00 data

UPDATE REWARDS_IMPACT_DATA_V5
SET ELEC_END = TRIM(TO_DATE('24-APR-17', 'dd mon yy'))
WHERE TRIM(TO_DATE(ELEC_END, 'dd mon yy')) =  TRIM(TO_DATE('01-JAN-00', 'dd mon yy'));
  
UPDATE REWARDS_IMPACT_DATA_V5
SET CONTRACT_END_DT = TRIM(TO_DATE('24-APR-17', 'dd mon yy'))
WHERE CONTRACT_END_DT =  '01-JAN-00';


UPDATE REWARDS_IMPACT_DATA_V5
SET GAS_END = TRIM(TO_DATE('24-APR-17', 'dd mon yy'))
WHERE TRIM(TO_DATE(GAS_END, 'dd mon yy')) =  TRIM(TO_DATE('01-JAN-00', 'dd mon yy'));


commit;


--Add churned rate to table
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD CHURNED NUMBER(38);

update REWARDS_IMPACT_DATA_V5 
SET CHURNED = (case when ((ELEC_END = TRIM(TO_DATE('24-APR-17', 'dd mon yy'))) or 
(GAS_END  = TRIM(TO_DATE('24-APR-17', 'dd mon yy'))) or (CONTRACT_END_DT  = '24-APR-27')) then 0 else 1 end);

--aDD CONTRACT START DATE TO TABLE

ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD START_DATE date;

UPDATE REWARDS_IMPACT_DATA_V5
SET START_DATE = (case when ELEC_START < GAS_START and elec_start is not null then ELEC_START
                  when GAS_START IS NULL THEN ELEC_START
                  else GAS_START end);

--create contract end date
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD END_DATE date;

UPDATE REWARDS_IMPACT_DATA_V5 
SET END_DATE = (case when ELEC_END > GAS_END and ELEC_END is not null then ELEC_END 
              when GAS_END IS NULL THEN ELEC_END
              else GAS_END end);

commit;

--delete data where they started after 24/4/2017
DELETE FROM REWARDS_IMPACT_DATA_V5
WHERE START_DATE > '24-APR-17';

DELETE FROM REWARDS_IMPACT_DATA_V5
WHERE END_DATE < '01-NOV-16';



--delete custoemrs who have just had boiler service and not gas/elec/df
delete from REWARDS_IMPACT_DATA_V5
where BOILERID is not null
and GASID is null
and ELECID is null
and CONTRACT is null;

ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD BOILER number(38);
UPDATE REWARDS_IMPACT_DATA_V5 
SET BOILER = (case when boiler_service >= trunc(END_DATE) - 426 then 1 else 0 end);

--calculate number days customer
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DAYS_CUST number;

UPDATE REWARDS_IMPACT_DATA_V5 SET DAYS_CUST = (END_DATE - START_DATE);

--calaculate number days gas
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DAYS_GAS number;

UPDATE REWARDS_IMPACT_DATA_V5 SET DAYS_GAS = (GAS_END - GAS_START);

--calculate number days elec
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DAYS_ELEC number;

UPDATE REWARDS_IMPACT_DATA_V5 SET DAYS_ELEC = (ELEC_END - ELEC_START);

--calculate number days DF
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DAYS_DF number;

UPDATE REWARDS_IMPACT_DATA_V5 SET DAYS_DF = (CONTRACT_END_DT - CONTRACT_START_DT);

--calculate number days rewards
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DAYS_REWARDS number;

UPDATE REWARDS_IMPACT_DATA_V5 SET DAYS_REWARDS = (END_DATE - trunc(REGISTERED_DATE));

--calculate whether rewards
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD REWARDS number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET REWARDS = (CASE when REGISTERED_DATE IS NOT NULL THEN 1 ELSE 0 END);

--mark people who left after 1st year discount
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD PAST_1ST_YR_DISC number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET PAST_1ST_YR_DISC = (case when DAYS_CUST > 365 then 1 else 0 end); 

--calculate levelpay
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD LEVELPAY number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET LEVELPAY = (case when ELEC_LEVELPAY_DSCNT = 'NBB_ELEC' or GAS_LEVELPAY_DSCNT = 'NBB' then 1 else 0 end);

--calculate paperless
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD PAPERLESS number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET PAPERLESS = (case when ELEC_PAPERLESS_DSCNT = 'PAPLESS' or GAS_PAPERLESS_DSCNT = 'PAPLESS' then 1 else 0 end);

--calculate clubcard
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD CLUBCARD number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET CLUBCARD = (case when TESCO_CLUBCARD IS NOT NULL THEN 1 ELSE 0 end);

--calculate df_discount
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD DF_DISCOUNT number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET DF_DISCOUNT = (case when CONTRACT IS NOT NULL then 1 else 0 end);

--ADD EVER REGISTERED INTO REWARDS
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD REWARDS_REG number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET REWARDS_REG = (case when REGISTERED_DATE IS NOT NULL then 1 else 0 end);

--ADD EVER LOGGED IN
ALTER TABLE REWARDS_IMPACT_DATA_V5 ADD REWARDS_LOGIN number(38);

UPDATE REWARDS_IMPACT_DATA_V5 SET REWARDS_LOGIN = (case when FIRST_LOGIN IS NOT NULL then 1 else 0 end);

--set rewards data to 0 rather than NULL if customers have registered to see difference between not registered and registered
UPDATE REWARDS_IMPACT_DATA_V5
SET BOOST_AMOUNT = 0
WHERE REGISTERED_DATE IS NOT NULL
AND BOOST_AMOUNT IS NULL;

UPDATE REWARDS_IMPACT_DATA_V5
SET PASSCODE_CNT = 0
WHERE REGISTERED_DATE IS NOT NULL 
AND PASSCODE_CNT IS NULL;

UPDATE REWARDS_IMPACT_DATA_V5
SET BOOST_COUNT = 0
WHERE REGISTERED_DATE IS NOT NULL
AND BOOST_COUNT IS NULL;

--delete data where customers started rewards after they closed their accounts
DELETE FROM REWARDS_IMPACT_DATA_V5
WHERE DAYS_REWARDS < 0;

commit;

create table REWARDS_IMPACT_FINAL_V5 AS

select days_cust as days_cust
,personid
,boilerid
,elecid
,rewardsid
,gasid
,days_gas
,days_elec
,boiler
,days_rewards
,days_DF
,segment
,elec_wildcard_used as wildcard_status
,ca_billing_county_desc as county
,channel
,boost_amount
,boost_count
,passcode_cnt
,comp_count
,PAST_1ST_YR_DISC
,levelpay
,paperless
,clubcard
,churned
,df_discount
,rewards_reg
,first_login as rewards_login
from REWARDS_IMPACT_DATA_V5;

commit;
